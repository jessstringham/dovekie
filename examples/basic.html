<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Basic Dovekie Test!</title>
    <style>
      #gui-box {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
      }

      .container {
        display: flex;
        position: relative;
      }

      #editor-container {
        width: 400px;
        height: 400px;
        margin-right: 20px;
      }

      #sketch {
        width: 400px;
        height: 400px;
        margin-right: 20px;
      }

      #kaoss {
        width: 320px;
        height: 320px;
        background-color: antiquewhite;
      }
    </style>
  </head>

  <body>
    <h1>Dovekie</h1>
    <div class="container">
      <div>
        <svg
          id="sketch"
          width="400"
          height="400"
          style="border: 1px solid black"
        >
          <circle id="circle" cx="50" cy="50" r="30" fill="blue" />
        </svg>
      </div>
      <div id="editor-container"></div>
      <div id="kaoss"></div>
    </div>

    <link rel="stylesheet" href="../dist/dovekie.css" />
    <script type="module">
      import { Dovekie, wasmInit } from "../dist/dovekie.js";

      let INITIAL_CONFIG = {
        xy: [
          "s(floor(rn(t * 0.3, 42) * 4) / 3, 0, w)",
          "s(ramp(t, 0.3), h, 0)",
        ],
        gray: "my/h",
      };
      let SCHEMA_HINTS = {
        xy: "Vec2",
        gray: "Num",
      };

      // example of setting up custom variables!
      let CUSTOM_VARIABLES = {};

      function setup_kaoss() {
        CUSTOM_VARIABLES.kx = 0;
        CUSTOM_VARIABLES.ky = 0;

        const kaoss = document.getElementById("kaoss");
        kaoss.style.width = "300px";
        kaoss.style.height = "300px";

        const svgNS = "http://www.w3.org/2000/svg";
        const kaossSvg = document.createElementNS(svgNS, "svg");
        kaossSvg.setAttribute("width", "300");
        kaossSvg.setAttribute("height", "300");
        kaoss.appendChild(kaossSvg);

        kaoss.addEventListener("mousemove", function (event) {
          const rect = kaoss.getBoundingClientRect();
          const x = event.clientX - rect.left;
          const y = event.clientY - rect.top;
          CUSTOM_VARIABLES.kx = x / rect.width;
          CUSTOM_VARIABLES.ky = y / rect.height;
        });
      }

      async function main() {
        await wasmInit();
        let model = new Dovekie();

        let div = document.getElementById("sketch");
        model.set_bpm(80);
        model.set_div(div);

        // initialize the config. This is also used by setup gui to infer a schema!
        await model.set_config(INITIAL_CONFIG);

        let editor_container = document.getElementById("editor-container");

        await model.setup_gui(editor_container, {
          schema_hints: SCHEMA_HINTS,
          sketch_name: "basic",
        });

        console.log(model.gui.history());

        // model.gui.clear_history();

        // i think it'll just be await model.set_config(item.conf);

        // model.gui.rename_history(item.uuid, "new name");
        // model.gui.clear_history();

        // this will set up some custom variables
        setup_kaoss();

        function animate() {
          // if you need to ping for variables, do it here!
          // in this case, we're using an event, so it should be up-to-date
          // update_custom_variables();
          model.update({ custom_variables: CUSTOM_VARIABLES }); // call once per frame!

          const params = model.params();
          // example format of params
          // {
          //   data: 0.214,
          //   nested: {
          //     nested_thing: 1.0,
          //     test: [1, 2, 0.214],
          //   },
          // }

          // example code that updates a circle!!
          const svg = document.getElementById("svg");
          let circle = document.getElementById("circle");
          if (circle && params.xy) {
            circle.setAttribute("cx", params.xy[0]);
            circle.setAttribute("cy", params.xy[1]);
            const gray = Math.max(0, Math.min(1, params.gray));
            const gray255 = Math.round(gray * 255);
            circle.setAttribute(
              "fill",
              `rgb(${gray255},${gray255},${gray255})`
            );
            circle.setAttribute("stroke", "black");
            circle.setAttribute("stroke-width", "2");
          }

          requestAnimationFrame(animate);
        }

        requestAnimationFrame(animate);
      }

      document.addEventListener("DOMContentLoaded", async () => {
        main();
      });
    </script>
  </body>
</html>
